name: Installation Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'quick-install.sh'
      - 'verify.php'
      - 'docker-compose*.yml'
      - '.env.*'
      - 'composer.json'
      - '.github/workflows/installation-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'quick-install.sh'
      - 'verify.php'
      - 'docker-compose*.yml'
      - '.env.*'
      - 'composer.json'

jobs:
  script-validation:
    runs-on: ubuntu-latest
    name: Validate Scripts

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: gd, json, pdo, pdo_mysql, mbstring

      - name: Validate bash scripts
        run: |
          echo "Checking bash script syntax..."
          bash -n quick-install.sh
          bash -n tests/install-test.sh
          bash -n tests/docker-test.sh

      - name: Validate PHP syntax
        run: |
          echo "Checking PHP script syntax..."
          php -l verify.php
          php -l src/WeathermapNG.php

  docker-test:
    runs-on: ubuntu-latest
    name: Docker Compose Validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare environment
        run: |
          cp .env.docker .env
          sed -i 's/your_db_name/testdb/g' .env
          sed -i 's/your_db_user/testuser/g' .env
          sed -i 's/your_db_password/testpass/g' .env
          sed -i 's/your_root_password/rootpass/g' .env

      - name: Validate Docker Compose files
        run: |
          for f in docker-compose.simple.yml docker-compose.example.yml; do
            if [ -f "$f" ]; then
              echo "Validating $f..."
              docker compose -f "$f" config > /dev/null
            fi
          done

  plugin-structure:
    runs-on: ubuntu-latest
    name: Validate Plugin Structure

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          echo "Checking plugin structure..."
          for file in src/WeathermapNG.php routes/web.php composer.json phpunit.xml README.md INSTALL.md; do
            test -f "$file" || (echo "MISSING: $file" && exit 1)
            echo "  OK: $file"
          done

      - name: Check hook files
        run: |
          for hook in MenuEntry Settings; do
            test -f "src/Hooks/$hook.php" || (echo "MISSING: src/Hooks/$hook.php" && exit 1)
            echo "  OK: src/Hooks/$hook.php"
          done

  documentation-check:
    runs-on: ubuntu-latest
    name: Documentation Validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation files
        run: |
          echo "Checking required documentation..."
          for doc in README.md INSTALL.md API.md DEPLOYMENT.md CHANGELOG.md; do
            test -f "$doc" || (echo "MISSING: $doc" && exit 1)
            echo "  OK: $doc"
          done

  security-check:
    runs-on: ubuntu-latest
    name: Security Checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded credentials
        run: |
          echo "Checking for hardcoded credentials..."
          FOUND=0
          if grep -r "password\s*=\s*['\"][^'\"]*['\"]" --include="*.php" --exclude-dir=vendor . 2>/dev/null | grep -v "password';" | grep -v "password\s*=\s*['\"]\$"; then
            echo "Warning: Found potential hardcoded passwords"
            FOUND=1
          fi
          if grep -r "api[_-]key\s*=\s*['\"][^'\"]*['\"]" --include="*.php" --exclude-dir=vendor . 2>/dev/null | grep -v "api_key\s*=\s*['\"]\$"; then
            echo "Warning: Found potential hardcoded API keys"
            FOUND=1
          fi
          if [ "$FOUND" -eq 0 ]; then
            echo "No hardcoded credentials detected"
          fi
